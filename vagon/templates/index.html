<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка портового терминала</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; }
        .container { max-width: 1200px; }
        #sql-query-result, #stats-result { max-height: 400px; overflow-y: auto; }
        .spinner-border { display: none; }
        .error-msg { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Аналитическая панель портового терминала</h1>

        <!-- Секция статистики -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Статистика по таблицам БД</h5>
            </div>
            <div class="card-body">
                <button id="load-stats-btn" class="btn btn-primary">Загрузить статистику</button>
                <div class="spinner-border spinner-border-sm ms-2" role="status" id="stats-spinner"></div>
                <div id="stats-result" class="mt-3"></div>
                <div id="stats-error" class="error-msg mt-2"></div>
            </div>
        </div>

        <!-- Секция генерации и выполнения SQL -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Конструктор SQL-запросов с помощью LLM</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="model-select" class="form-label">Выберите модель LLM:</label>
                    <select class="form-select" id="model-select">
                        <option value="">Загрузка моделей...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="user-query" class="form-label">Введите ваш запрос на естественном языке:</label>
                    <textarea class="form-control" id="user-query" rows="3" placeholder="Пример: 'Покажи 5 самых тяжелых грузов, принятых в этом месяце'"></textarea>
                </div>
                <div class="mb-3">
                    <small class="form-text text-muted">Или выберите пример:</small><br>
                    <a href="#" class="query-example small">Покажи, как менялась выгрузка вагонов в течение 2 последних лет, ежемесячно</a><br>
                    <a href="#" class="query-example small">Как менялся показатель среднемесячной погрузки на суда последние 2 года</a><br>
                    <a href="#" class="query-example small">Как менялся показатель времени выгрузки вагона в зависимости от фронтов выгрузки</a><br>
                    <a href="#" class="query-example small">Как менялся показатель ежегодной выгрузки вагонов в разрезе родов груза</a><br>
                    <a href="#" class="query-example small">Как менялся показатель ежегодной выгрузки вагонов в разрезе грузоотправителей</a><br>
                    <a href="#" class="query-example small">Предоставь данные по отгрузкам в адрес порта за предыдущий месяц</a><br>
                    <a href="#" class="query-example small">Сколько выгрузили вчера вагонов в разрезе рода груза</a>
                </div>
                <button id="generate-sql-btn" class="btn btn-success">Сгенерировать SQL</button>
                <div class="spinner-border spinner-border-sm ms-2" role="status" id="generate-spinner"></div>
                
                <div class="mt-3">
                    <label for="sql-query" class="form-label">Сгенерированный SQL-запрос:</label>
                    <textarea class="form-control" id="sql-query" rows="4"></textarea>
                    <small class="form-text text-muted">Вы можете отредактировать SQL-запрос перед выполнением</small>
                    <div id="generate-error" class="error-msg mt-2"></div>
                </div>

                <div class="mt-3">
                    <label for="llm-prompt" class="form-label">Точный промпт, отправленный в LLM:</label>
                    <textarea class="form-control" id="llm-prompt" rows="8" readonly style="font-size: 12px; background-color: #f8f9fa;"></textarea>
                </div>

                <button id="execute-sql-btn" class="btn btn-info mt-2" disabled>Выполнить SQL</button>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="create-chart-checkbox">
                    <label class="form-check-label" for="create-chart-checkbox">
                        Создать график (если данные подходят)
                    </label>
                </div>
                <div class="spinner-border spinner-border-sm ms-2" role="status" id="execute-spinner"></div>
                
                <h6 class="mt-4">Результат выполнения:</h6>
                <div id="chart-container" class="mt-3" style="display: none;">
                    <h6>График:</h6>
                    <img id="chart-image" class="img-fluid border" alt="График данных" style="max-width: 100%; height: auto;">
                </div>
                <div id="sql-query-result" class="border p-2 bg-light"></div>
                <div id="execute-error" class="error-msg mt-2"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script>
        // Функция для отображения ошибок
        function showError(elementId, message) {
            const errorEl = $(`#${elementId}`);
            errorEl.text(message);
            errorEl.show();
        }

        // Функция для отображения данных в виде таблицы
        function renderTable(elementId, data) {
            const container = $(`#${elementId}`);
            container.empty();
            if (data.length === 0) {
                container.text("Нет данных для отображения.");
                return;
            }
            const table = $('<table class="table table-bordered table-striped"></table>');
            const thead = $('<thead><tr></tr></thead>');
            const tbody = $('<tbody></tbody>');

            // Заголовки
            Object.keys(data[0]).forEach(key => {
                thead.find('tr').append(`<th>${key}</th>`);
            });

            // Строки
            data.forEach(row => {
                const tr = $('<tr></tr>');
                Object.values(row).forEach(val => {
                    tr.append(`<td>${val}</td>`);
                });
                tbody.append(tr);
            });

            table.append(thead).append(tbody);
            container.append(table);
        }

        $(document).ready(function() {
            // Загрузка доступных моделей
            function loadModels() {
                $.ajax({
                    url: '/api/models',
                    method: 'GET',
                    success: function(data) {
                        const modelSelect = $('#model-select');
                        modelSelect.empty();
                        
                        // Добавляем опции для каждой модели
                        data.models.forEach(function(model) {
                            const option = $('<option></option>');
                            option.val(model);
                            option.text(model);
                            if (model === data.current_model) {
                                option.attr('selected', true);
                            }
                            modelSelect.append(option);
                        });
                    },
                    error: function(jqXHR) {
                        $('#model-select').html('<option>Ошибка загрузки моделей</option>');
                    }
                });
            }
            
            // Загружаем модели при загрузке страницы
            loadModels();
            
            // Обработчик изменения модели
            $('#model-select').on('change', function() {
                const selectedModel = $(this).val();
                if (selectedModel) {
                    $.ajax({
                        url: '/api/models/set',
                        method: 'POST',
                        data: JSON.stringify({model_name: selectedModel}),
                        contentType: 'application/json',
                        success: function(data) {
                            console.log('Модель изменена на:', selectedModel);
                        },
                        error: function(jqXHR) {
                            console.error('Ошибка при смене модели:', jqXHR.responseJSON?.error);
                        }
                    });
                }
            });
            
            // Загрузка статистики
            $('#load-stats-btn').on('click', function() {
                $('#stats-spinner').show();
                $('#stats-error').hide();
                $('#stats-result').empty();

                $.ajax({
                    url: '/api/stats',
                    method: 'GET',
                    success: function(data) {
                        if (data.error) {
                            showError('stats-error', `Ошибка: ${data.error}`);
                        } else {
                            renderTable('stats-result', data);
                        }
                    },
                    error: function(jqXHR) {
                        showError('stats-error', `Ошибка сервера: ${jqXHR.responseJSON?.error || jqXHR.statusText}`);
                    },
                    complete: function() {
                        $('#stats-spinner').hide();
                    }
                });
            });

            // Глобальная переменная для хранения схемы
            let cachedSchema = null;

            // Функция для получения схемы с сервера
            function getSchemaFromServer() {
                return $.ajax({
                    url: '/api/get-schema',
                    method: 'GET',
                    async: false
                }).responseJSON;
            }

            // Функция для формирования полного промпта (точная копия из Python)
            function buildFullPrompt(userQuery, schemaInfo) {
                return `You are an expert SQL Server database analyst. Your task is to generate ONLY valid SQL queries based on the provided database schema.

CRITICAL RULES - FOLLOW EXACTLY OR RETURN ERROR:
1. Use ONLY table names and column names from the provided schema below
2. NEVER invent or guess table names - only use what is explicitly listed
3. Always use [dbo].[TableName] format for tables
4. Always use [ColumnName] format for columns
5. Use SQL Server syntax (not MySQL LIMIT - use TOP instead)
6. For date operations use SQL Server functions: GETDATE(), DATEADD(), YEAR(), MONTH()
7. Return ONLY the SQL query without explanations or markdown

DATABASE SCHEMA (USE ONLY THESE TABLES AND COLUMNS):
${schemaInfo}

VALIDATION STEPS - FOLLOW BEFORE GENERATING SQL:
1. Read the user request carefully
2. Scan the schema above for relevant tables
3. Verify the table name exists in the schema
4. Verify the column names exist in the chosen table
5. If ANY table or column name is not found in the schema above, return: "ERROR: No suitable tables found in schema for this request"

EXAMPLES OF CORRECT MAPPING:
- "страны назначения" → Look for [Страна назначения] column → Found in [dbo].[ShipsPlan] table
- "типы судов" → Look for [Судно] column → Found in [dbo].[ShipsImport], [dbo].[ShipsPlan] tables
- "операции импорта вагонов" → Look for import/wagon tables → Found in [dbo].[VagonImport], [dbo].[UploadWagonsImport]

USER REQUEST: ${userQuery}

First, verify that appropriate tables exist in the schema. Then generate SQL query using ONLY the tables and columns from the schema above:`;
            }

            // Генерация SQL
            $('#generate-sql-btn').on('click', function() {
                const userQuery = $('#user-query').val();
                if (!userQuery) {
                    showError('generate-error', 'Поле запроса не может быть пустым.');
                    return;
                }

                // Получаем схему с сервера, если еще не получили
                if (!cachedSchema) {
                    try {
                        cachedSchema = getSchemaFromServer();
                    } catch (e) {
                        cachedSchema = "Не удалось загрузить схему с сервера";
                    }
                }

                // СРАЗУ показываем полный промпт перед отправкой
                const fullPrompt = buildFullPrompt(userQuery, cachedSchema.schema || cachedSchema);
                $('#llm-prompt').val(fullPrompt);

                $('#generate-spinner').show();
                $('#generate-error').hide();
                $('#sql-query').val('');
                $('#execute-sql-btn').prop('disabled', true);

                $.ajax({
                    url: '/api/generate-sql',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ query: userQuery }),
                    success: function(data) {
                        console.log('Ответ от API:', data); // Добавляем логирование
                        if (data.error) {
                            showError('generate-error', `Ошибка генерации: ${data.error}`);
                        } else {
                            console.log('Полученный SQL:', data.sql_query); // Добавляем логирование
                            $('#sql-query').val(data.sql_query);
                            $('#execute-sql-btn').prop('disabled', false);
                        }
                    },
                    error: function(jqXHR) {
                        console.error('Ошибка AJAX:', jqXHR); // Добавляем логирование
                        showError('generate-error', `Ошибка сервера: ${jqXHR.responseJSON?.error || jqXHR.statusText}`);
                    },
                    complete: function() {
                        $('#generate-spinner').hide();
                    }
                });
            });

            // Выполнение SQL
            $('#execute-sql-btn').on('click', function() {
                const sqlQuery = $('#sql-query').val();
                const userQuery = $('#user-query').val();
                const createChart = $('#create-chart-checkbox').is(':checked');
                
                if (!sqlQuery) {
                    showError('execute-error', 'Нет SQL-запроса для выполнения.');
                    return;
                }

                $('#execute-spinner').show();
                $('#execute-error').hide();
                $('#sql-query-result').empty();
                $('#chart-container').hide();

                // Определяем какой API использовать
                const apiUrl = createChart ? '/api/execute-sql-with-chart' : '/api/execute-sql';
                const requestData = createChart 
                    ? { query: sqlQuery, user_query: userQuery, create_chart: true }
                    : { query: sqlQuery };

                $.ajax({
                    url: apiUrl,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function(response) {
                        // Обработка ошибок
                        if (response.error) {
                            showError('execute-error', `Ошибка выполнения: ${response.error}`);
                            return;
                        }
                        
                        // Обработка данных
                        const data = response.data || response;
                        if (Array.isArray(data)) {
                            renderTable('sql-query-result', data);
                        } else {
                            $('#sql-query-result').text(JSON.stringify(data, null, 2));
                        }
                        
                        // Обработка графика
                        if (response.chart) {
                            $('#chart-image').attr('src', 'data:image/png;base64,' + response.chart);
                            $('#chart-container').show();
                        }
                    },
                    error: function(jqXHR) {
                        showError('execute-error', `Ошибка сервера: ${jqXHR.responseJSON?.error || jqXHR.statusText}`);
                    },
                    complete: function() {
                        $('#execute-spinner').hide();
                    }
                });
            });

            // Обработка клика по примерам
            $('.query-example').on('click', function(e) {
                e.preventDefault(); // Отменяем стандартное поведение ссылки
                const exampleText = $(this).text();
                $('#user-query').val(exampleText);
            });
        });
    </script>
</body>
</html>
