{% extends "admin/base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - B2B SEO-Platform Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h2>–î–∞—à–±–æ—Ä–¥</h2>
    <div class="breadcrumb">
        <a href="/admin">–î–∞—à–±–æ—Ä–¥</a>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="card">
    <h3>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--secondary-color);" id="totalPages">0</div>
            <div style="color: #495057; font-size: 0.9rem; font-weight: 500;">SEO-—Å—Ç—Ä–∞–Ω–∏—Ü</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--success-color);" id="totalKeywords">0</div>
            <div style="color: #495057; font-size: 0.9rem; font-weight: 500;">–ö–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--warning-color);" id="avgKeywords">0</div>
            <div style="color: #495057; font-size: 0.9rem; font-weight: 500;">–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª-–≤–æ –∫–ª—é—á–µ–π</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);" id="lastGenerated">-</div>
            <div style="color: #495057; font-size: 0.9rem; font-weight: 500;">–ü–æ—Å–ª–µ–¥–Ω—è—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º -->
<div class="card">
    <h3>üõçÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º</h3>
    <div class="products-stats-grid" id="productsStatsGrid">
        <!-- –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="card">
    <h3>üöÄ –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
        <div>
            <h4>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h4>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <a href="/admin/create-page" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>
                <a href="/admin/bulk-generate" class="btn btn-success">üì¶ –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</a>
                <a href="/admin/generate-cluster" class="btn btn-warning">üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞</a>
            </div>
            
            <form id="quickCreateForm" style="margin-top: 1rem;">
                <div class="form-group">
                    <label for="quickKeyword">–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ:</label>
                    <div class="input-group">
                        <input type="text" id="quickKeyword" name="keyword" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ">
                        <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                </div>
            </form>
        </div>

        <div>
            <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h4>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <a href="/admin/seo-pages" class="btn btn-primary">üìÑ –í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</a>
                <a href="/admin/analytics" class="btn btn-secondary">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
                <button class="btn btn-warning" onclick="refreshStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                <h5>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h5>
                <div id="systemStatus">
                    <div>üü¢ LLM —Å–µ—Ä–≤–∏—Å: <span id="llmStatus">–ì–æ—Ç–æ–≤</span></div>
                    <div>üü¢ –ö—ç—à —Å–µ—Ä–≤–∏—Å: <span id="cacheStatus">–ì–æ—Ç–æ–≤</span></div>
                    <div>üü¢ SEO —Å–µ—Ä–≤–∏—Å: <span id="seoStatus">–ì–æ—Ç–æ–≤</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div class="card">
    <h3>üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
    <div id="recentPages">
        <div class="loading" id="recentPagesLoading">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
    <div style="margin-top: 1rem;">
        <a href="/admin/seo-pages" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class AdminDashboard {
    constructor() {
        this.init();
    }

    async init() {
        await this.loadStats();
        await this.loadRecentPages();
        this.setupEventListeners();
        await this.loadProductsStats();
    }

    setupEventListeners() {
        document.getElementById('quickCreateForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleQuickCreate();
        });
    }

    async loadStats() {
        try {
            const response = await fetch('/api/v1/seo_pages_list');
            if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É');
            
            const pages = await response.json();
            this.updateStats(pages);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        }
    }

    updateStats(pages) {
        const totalKeywords = pages.reduce((sum, page) => sum + (page.meta_keywords ? page.meta_keywords.length : 0), 0);
        const avgKeywords = pages.length > 0 ? Math.round(totalKeywords / pages.length) : 0;

        document.getElementById('totalPages').textContent = pages.length;
        document.getElementById('totalKeywords').textContent = totalKeywords;
        document.getElementById('avgKeywords').textContent = avgKeywords;
        document.getElementById('lastGenerated').textContent = new Date().toLocaleDateString('ru-RU');
    }

    async loadRecentPages() {
        const loading = document.getElementById('recentPagesLoading');
        const container = document.getElementById('recentPages');
        
        try {
            loading.style.display = 'block';
            const response = await fetch('/api/v1/seo_pages_list');
            if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
            
            const pages = await response.json();
            const recentPages = pages.slice(0, 5); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö
            
            if (recentPages.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">–°—Ç—Ä–∞–Ω–∏—Ü –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                            <th>–°–ª–∞–≥</th>
                            <th>–ö–ª—é—á–∏</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentPages.map(page => `
                            <tr>
                                <td>${page.title}</td>
                                <td><code>/${page.slug}</code></td>
                                <td>${page.meta_keywords ? page.meta_keywords.length : 0}</td>
                                <td>
                                    <a href="/${page.slug}" class="btn btn-sm btn-primary" target="_blank">üëÅÔ∏è</a>
                                    <a href="/admin/edit-page/${page.slug}" class="btn btn-sm btn-warning">‚úèÔ∏è</a>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü:', error);
            container.innerHTML = '<div style="color: var(--danger-color);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü</div>';
        } finally {
            loading.style.display = 'none';
        }
    }

    async loadProductsStats() {
        const container = document.getElementById('productsStatsGrid');
        container.innerHTML = '<div class="spinner"></div>';

        try {
            const response = await fetch('/api/v1/products/stats');
            if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º');

            const stats = await response.json();
            
            const productsHtml = Object.entries(stats).map(([productId, data]) => {
                const productName = productId === 'contract_analysis' ? '–ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–æ–≤' : 
                                  productId === 'news_analysis' ? '–ê–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ—Å—Ç–µ–π' : productId;
                return `
                    <div style="padding: 1.5rem; background: white; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-color); font-size: 1.1rem;">${productName}</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <span style="font-size: 1.8rem; font-weight: bold; color: var(--secondary-color);">${data.seo_pages_count}</span>
                            <span style="font-size: 0.9rem; color: #6c757d; font-weight: 500;">SEO-—Å—Ç—Ä–∞–Ω–∏—Ü</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <a href="/admin/products/${productId}" class="btn btn-sm btn-primary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
                            <a href="/admin/generate-cluster?product_id=${productId}" class="btn btn-sm btn-success">–°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã</a>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = productsHtml || '<div style="color: #666; text-align: center; padding: 2rem;">–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', error);
            container.innerHTML = '<div style="color: var(--danger-color); text-align: center; padding: 2rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</div>';
        }
    }

    async handleQuickCreate() {
        const keyword = document.getElementById('quickKeyword').value.trim();
        if (!keyword) return;

        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–∑–¥–∞–Ω–∏—è —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–ª–µ–º
        window.location.href = `/admin/create-page?keyword=${encodeURIComponent(keyword)}`;
    }
}

function refreshStats() {
    window.location.reload();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    new AdminDashboard();
});
</script>

<style>
.products-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
